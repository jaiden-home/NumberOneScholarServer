# 数据库启动指南

本文档详细说明了如何在 Number One Scholar 服务器项目中启动和配置数据库服务。

## 项目结构

```
NumberOneScholarServer/
├── config/
├── controllers/
├── data/
│   └── mysql/
│       ├── db.js          # 数据库连接配置
│       ├── init.sql       # 数据库初始化脚本
│       └── userRepository.js
├── docker-compose.yml     # Docker Compose 配置文件
├── .env                   # 环境变量配置
└── ...
```

## 方法一：使用 Docker Compose（推荐）

### 步骤 1：安装 Docker Desktop

1. 访问 [Docker 官方网站](https://www.docker.com/products/docker-desktop) 下载并安装 Docker Desktop
2. 安装完成后，启动 Docker Desktop
3. 确保 Docker 服务正在运行（可以在任务栏/状态栏中查看 Docker 图标状态）

### 步骤 2：启动数据库服务

1. 打开终端，进入项目根目录：

   ```bash
   cd /Users/dey/Desktop/项目/NumberOneScholarServer
   ```

2. 执行以下命令启动 MySQL 容器：

   ```bash
   docker-compose up -d
   ```

3. 等待容器启动完成（通常需要 1-2 秒）

### 步骤 3：验证数据库服务

1. 执行以下命令检查容器状态：

   ```bash
   docker-compose ps
   ```

2. 你应该看到类似以下输出：

   ```
   NAME                      IMAGE       COMMAND                  SERVICE   CREATED         STATUS         PORTS
   numberone-scholar-mysql   mysql:8.0   "docker-entrypoint.s…"   mysql     6 seconds ago   Up 6 seconds   0.0.0.0:3306->3306/tcp
   ```

3. 确认 `STATUS` 为 `Up` 状态，说明数据库服务已成功启动

## 方法二：使用本地 MySQL 服务

### 步骤 1：安装 MySQL（如果未安装）

#### macOS 用户

```bash
# 使用 Homebrew 安装 MySQL
brew install mysql

# 启动 MySQL 服务
brew services start mysql
```

#### Windows 用户

1. 访问 [MySQL 官方网站](https://dev.mysql.com/downloads/installer/) 下载 MySQL Installer
2. 运行安装程序，按照向导完成安装
3. 在安装过程中设置 root 密码
4. 安装完成后，启动 MySQL 服务

#### Linux 用户

```bash
# Ubuntu/Debian 系统
sudo apt update
sudo apt install mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql

# 启用开机自启
sudo systemctl enable mysql
```

### 步骤 2：配置数据库

1. 连接到 MySQL 服务器：

   ```bash
   mysql -u root -p
   ```

2. 输入 root 密码后，执行以下 SQL 命令：

   ```sql
   -- 创建数据库
   CREATE DATABASE example_db;
   
   -- 创建用户
   CREATE USER 'admin'@'localhost' IDENTIFIED BY 'password';
   
   -- 授予权限
   GRANT ALL PRIVILEGES ON example_db.* TO 'admin'@'localhost';
   
   -- 刷新权限
   FLUSH PRIVILEGES;
   ```

3. 退出 MySQL 命令行：

   ```bash
   exit;
   ```

### 步骤 3：初始化表结构

1. 执行以下命令导入初始化脚本：

   ```bash
   mysql -u admin -p example_db < data/mysql/init.sql
   ```

2. 输入密码 `password` 完成导入

## 数据库配置信息

无论使用哪种方法，数据库配置信息如下：

| 配置项 | 值 |
|-------|-----|
| 主机 | localhost |
| 端口 | 3306 |
| 用户名 | admin |
| 密码 | password |
| 数据库名 | example_db |

## 验证数据库连接

启动服务器后，可以通过以下方式验证数据库连接：

1. 检查服务器日志，确认是否有 "Database connected successfully" 的消息
2. 访问 `http://localhost:3000/health` 端点，检查 `databaseConnected` 字段是否为 `true`
3. 访问 `http://localhost:3000/api/users` 端点，检查是否能够正常返回用户列表

## 可视化数据管理工具

### 使用 DBeaver（通用数据库工具）

1. **下载并安装 DBeaver**：
   - 访问 [DBeaver 官方下载页](https://dbeaver.io/download/)
   - 选择适合你操作系统的版本并安装（Community 版免费）

2. **配置连接**：
   - 打开 DBeaver
   - 点击 "数据库" → "新建连接"
   - 在弹出的对话框中选择 "MySQL"
   - 点击 "下一步"
   - 填写连接信息：
     - 主机：localhost
     - 端口：3306
     - 数据库：example_db
     - 用户名：admin
     - 密码：password
   - 点击 "测试连接" 测试连接
   - 点击 "完成" 保存连接

3. **连接数据库**：
   - 在 DBeaver 左侧导航栏中找到刚创建的连接
   - 双击连接名称启动连接
   - 展开连接节点，即可查看和管理数据库对象

### 查看数据库内容

无论使用哪种可视化工具，连接成功后都可以：

1. **查看数据库结构**：
   - 展开 "数据库" → "example_db" → "表"
   - 查看已创建的表结构，如 `users`、`tasks` 等

2. **查看数据**：
   - 右键点击表名，选择 "查看数据" 或 "编辑数据"
   - 在弹出的表格中查看和修改数据

3. **执行 SQL 查询**：
   - 打开 SQL 编辑器
   - 输入 SQL 查询语句，如：
     ```sql
     SELECT * FROM users;
     ```
   - 点击执行按钮查看结果

4. **管理数据库**：
   - 创建新表、修改表结构
   - 导入/导出数据
   - 执行备份和恢复操作

## 常见问题排查

### Docker 相关问题

1. **Docker 未启动**：确保 Docker Desktop 正在运行
2. **端口冲突**：检查 3306 端口是否被其他服务占用
3. **容器启动失败**：执行 `docker-compose logs` 查看详细错误信息

### MySQL 相关问题

1. **服务未启动**：检查 MySQL 服务状态
2. **密码错误**：确认使用正确的用户名和密码
3. **权限问题**：确保用户有足够的数据库权限

### 连接问题

1. **网络问题**：检查防火墙是否阻止了数据库连接
2. **配置错误**：检查 `.env` 文件中的数据库配置是否正确
3. **依赖问题**：确保已安装 `mysql2` 依赖包

## 停止数据库服务

### Docker 方法

```bash
# 停止并移除容器
docker-compose down

# 只停止容器（保留数据）
docker-compose stop
```

### 本地 MySQL 方法

#### macOS 用户

```bash
brew services stop mysql
```

#### Linux 用户

```bash
sudo systemctl stop mysql
```

## 数据持久化

- **Docker 方法**：数据存储在 Docker 卷中，容器重启后数据不会丢失
- **本地 MySQL 方法**：数据存储在本地 MySQL 数据目录中

## 注意事项

1. 首次启动时，Docker 会自动下载 MySQL 镜像，可能需要一些时间
2. 确保 `.env` 文件中的数据库配置与实际使用的配置一致
3. 生产环境中应使用强密码和适当的安全配置
4. 定期备份数据库以防止数据丢失

## 相关文件

- `docker-compose.yml`：Docker Compose 配置
- `data/mysql/init.sql`：数据库初始化脚本
- `data/mysql/db.js`：数据库连接代码
- `.env`：环境变量配置

---

通过以上步骤，你应该能够成功启动和配置数据库服务，为 Number One Scholar 服务器项目提供数据存储支持。